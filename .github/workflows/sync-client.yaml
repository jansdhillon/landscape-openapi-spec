# SPDX-License-Identifier: Apache-2.0

name: Bundle and sync API Client with OpenAPI spec, publish GitHub release/Go package 

on:
  push:
    branches: [main]

  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-openapi-bundle:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm install -g swagger-cli
      - run: make bundle
      - uses: actions/upload-artifact@v4
        with:
          name: openapi-bundle
          path: openapi/landscape_api.bundle.yaml
          if-no-files-found: error

  update-landscape-go-api-client-pr:
    needs: generate-openapi-bundle
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: openapi-bundle
          path: bundle

      - uses: actions/checkout@v4
        with:
          repository: jansdhillon/landscape-go-api-client
          path: landscape-go-api-client
          token: ${{ secrets.REGENERATE_CLIENT_TOKEN }}

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Generate client
        working-directory: landscape-go-api-client/client
        env:
          OPENAPI_SPEC: ${{ github.workspace }}/bundle/landscape_api.bundle.yaml
        run: |
          go generate ./...
          go mod tidy

      - name: Create/Update PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.REGENERATE_CLIENT_TOKEN }}
          path: landscape-go-api-client
          branch: build/regen-landscape-go-api-client
          commit-message: "build: regenerate client from OpenAPI spec"
          title: "build: regenerate client from OpenAPI spec"
          body: "Automated regeneration from latest OpenAPI bundle."
          labels: automated, generated
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          signoff: true

  tag-release-and-sync:
    needs: update-landscape-go-api-client-pr
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: openapi-bundle
          path: bundle

      - name: Read version from OpenAPI bundle
        id: ver
        uses: mikefarah/yq@v4
        with:
          cmd: yq -r '.info.version' 'bundle/landscape_api.bundle.yaml'

      - name: Compute tag names
        id: tag
        run: |
          VER="${{ steps.ver.outputs.result }}"
          if [ -z "$VER" ]; then
            echo "OpenAPI version not found"; exit 1
          fi
          [[ "$VER" =~ ^v ]] && MODTAG="$VER" || MODTAG="v$VER"
          echo "openapi_version=$VER" >> "$GITHUB_OUTPUT"
          echo "mod_tag=$MODTAG" >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@v4
        with:
          repository: jansdhillon/landscape-go-api-client
          path: clientrepo
          token: ${{ secrets.REGENERATE_CLIENT_TOKEN }}

      - name: Create tag on client repo at regen branch head
        working-directory: clientrepo
        env:
          PUSH_TOKEN: ${{ secrets.REGENERATE_CLIENT_TOKEN }}
          TAG: ${{ steps.tag.outputs.mod_tag }}
        run: |
          git fetch origin build/regen-landscape-go-api-client
          git checkout build/regen-landscape-go-api-client

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch --tags
          git tag -fa "$TAG" -m "Automated regen from OpenAPI spec ${{ steps.tag.outputs.openapi_version }}"
          git push -f origin "refs/tags/$TAG"
          git remote set-url origin "https://x-access-token:${PUSH_TOKEN}@github.com/jansdhillon/landscape-go-api-client.git"
          git push --force origin "refs/tags/$TAG"

          echo "TAG=$TAG" >> "$GITHUB_ENV"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.REGENERATE_CLIENT_TOKEN }}
        run: |
          if gh release view "$TAG" --repo jansdhillon/landscape-go-api-client; then
            gh release upload "$TAG" "$GITHUB_WORKSPACE/bundle/landscape_api.bundle.yaml" \
              --repo jansdhillon/landscape-go-api-client --clobber
          else
            gh release create "$TAG" \
              --repo jansdhillon/landscape-go-api-client \
              --title "$TAG" \
              --notes "Automated regeneration from OpenAPI spec ${{ steps.tag.outputs.openapi_version }}." \
              "$GITHUB_WORKSPACE/bundle/landscape_api.bundle.yaml"
          fi

      - name: Trigger Go module proxy indexing
        working-directory: clientrepo
        env:
          TAG: ${{ env.TAG }}
        run: |
          MOD="github.com/jansdhillon/landscape-go-api-client"
          VER="$TAG"
          GOPROXY=https://proxy.golang.org GO111MODULE=on go get "${MOD}@${VER}"
